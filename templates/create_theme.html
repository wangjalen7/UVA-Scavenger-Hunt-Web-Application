<!DOCTYPE html>
<html>
{% extends "base.html" %}
{% load static %}
{% block content %}

<head>
    
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMaps" async defer></script>
    <style>
        .map {
            height: 200px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container text-center">
        <h1 style="font-size: 70px;">Create Theme</h1>
    </div>
    <div class="container-fluid text-center">
        <form method="post" action="{% url 'create_theme' %}" class="mt-4" id="theme-form">
            {% csrf_token %}
            <div class="card-body">
                {{ form.non_form_errors }}

                <input type="text" name="title" placeholder="Theme Title" required>
                <textarea name="description" placeholder="Theme Description" required></textarea>

                <h2>Tasks</h2>
                <div id="task-container">
                    <div class="task-inputs">
                        <input type="text" class="task-name" placeholder="Task Name" required>
                        <textarea class="task-task" placeholder="Task" required></textarea>
                        <textarea class="task-hint" placeholder="Task Hint" required></textarea>
                        <div id="map0" class="map"></div>
                        <input type="hidden" class="task-latitude" required>
                        <input type="hidden" class="task-longitude" required>
                    </div>
                </div>
                <button type="button" id="add-task" class="btn btn-info">Add Task</button>
                <button type="button" id="delete-task" class="btn btn-warning">Delete Last Task</button>

                <input type="hidden" name="tasks_json" id="tasks-json">
                <button type="submit" class="btn btn-primary">Create Theme</button>
            </div>
        </form>
    </div>

    <script>
        let maps = [];
        let markers = [];
        let mapCount = 0;
    
        function initMaps() {
            addMapToTask(0);
        }
    
        function addMapToTask(taskIndex) {
            const defaultPosition = { lat: -34.397, lng: 150.644 };
            const mapDiv = document.getElementById(`map${taskIndex}`);
            const map = new google.maps.Map(mapDiv, {
                center:{lat: 38.0336, lng: -78.5080},
                zoom: 14
            });
    
            maps[taskIndex] = map;
            markers[taskIndex] = null; // Initialize marker
    
            map.addListener('click', function(mapsMouseEvent) {
                const latLng = mapsMouseEvent.latLng.toJSON();
                updateTaskCoordinates(taskIndex, latLng.lat, latLng.lng);
                placeMarker(taskIndex, latLng);
            });
        }
    
        function placeMarker(taskIndex, latLng) {
            if (markers[taskIndex]) {
                // Move existing marker
                markers[taskIndex].setPosition(latLng);
            } else {
                // Create new marker
                markers[taskIndex] = new google.maps.Marker({
                    position: latLng,
                    map: maps[taskIndex]
                });
            }
        }
    
        function updateTaskCoordinates(taskIndex, lat, lng) {
            const taskContainer = document.getElementById(`task-container`).children[taskIndex];
            taskContainer.querySelector('.task-latitude').value = lat;
            taskContainer.querySelector('.task-longitude').value = lng;
        }
    
        document.getElementById('add-task').addEventListener('click', function() {
            mapCount++;
            let taskContainer = document.getElementById('task-container');
            let newTaskDiv = document.createElement('div');
            newTaskDiv.className = 'task-inputs';
            newTaskDiv.innerHTML = `
                <input type="text" class="task-name" placeholder="Task Name" required>
                <textarea class="task-task" placeholder="Task" required></textarea>
                <textarea class="task-hint" placeholder="Task Hint" required></textarea>
                <div id="map${mapCount}" class="map"></div>
                <input type="hidden" class="task-latitude" required>
                <input type="hidden" class="task-longitude" required>
            `;
            taskContainer.appendChild(newTaskDiv);
            addMapToTask(mapCount);
        });
    
        document.getElementById('delete-task').addEventListener('click', function() {
            let taskContainer = document.getElementById('task-container');
            if (taskContainer.children.length > 1) {
                taskContainer.removeChild(taskContainer.lastChild);
                markers.pop(); // Remove the marker for the deleted task
                maps.pop(); // Remove the map for the deleted task
                mapCount--;
            } else {
                alert('At least one task must remain.');
            }
        });
        
        function gatherTasksData() {
        let tasks = [];
        document.querySelectorAll('.task-inputs').forEach((taskDiv, index) => {
            let task = {
                name: taskDiv.querySelector('.task-name').value,
                task: taskDiv.querySelector('.task-task').value,
                hint: taskDiv.querySelector('.task-hint').value,
                latitude: markers[index] ? markers[index].getPosition().lat() : '',
                longitude: markers[index] ? markers[index].getPosition().lng() : ''
            };
            tasks.push(task);
        });
        return tasks;
    }

    document.getElementById('theme-form').addEventListener('submit', function(event) {
        const tasksData = gatherTasksData();
        document.getElementById('tasks-json').value = JSON.stringify(tasksData);
    });
</script>
</body>
{% endblock %}
</html>
